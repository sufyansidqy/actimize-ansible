---
- name: Install Tomcat
  hosts: actone
  gather_facts: no
  become: yes
  tasks:
    - name: Download Tomcat 9.0.106
      ansible.builtin.get_url:
        url: https://downloads.apache.org/tomcat/tomcat-9/v9.0.106/bin/apache-tomcat-9.0.106.tar.gz
        dest: /tmp/apache-tomcat-9.0.106.tar.gz
        mode: '0644'
      register: download_tomcat

    - name: Extract Tomcat
      ansible.builtin.unarchive:
        src: /tmp/apache-tomcat-9.0.106.tar.gz
        dest: /opt/
        remote_src: yes
        creates: /opt/apache-tomcat-9.0.106
        mode: 0744
    
    - name: Create Tomcat systemd service unit file
      ansible.builtin.copy:
        dest: /etc/systemd/system/tomcat.service
        content: |
          [Unit]
          Description=Apache Tomcat Web Application Container
          After=network.target

          [Service]
          Type=forking

          Environment=JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
          Environment=CATALINA_PID=/opt/apache-tomcat-9.0.106/temp/tomcat.pid
          Environment=CATALINA_HOME=/opt/apache-tomcat-9.0.106
          Environment=CATALINA_BASE=/opt/apache-tomcat-9.0.106
          Environment='CATALINA_OPTS=-Xms512M -Xmx1024M -server -XX:+UseParallelGC'
          Environment='JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom'

          ExecStart=/opt/apache-tomcat-9.0.106/bin/startup.sh
          ExecStop=/opt/apache-tomcat-9.0.106/bin/shutdown.sh

          User=actimize
          Group=actimize
          UMask=0007
          RestartSec=10
          Restart=always

          [Install]
          WantedBy=multi-user.target
        mode: '0777'

    - name: Reload Tomcat systemd daemon
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: Enable Tomcat service
      ansible.builtin.systemd:
        name: tomcat
        enabled: yes

    - name: Start Tomcat service
      ansible.builtin.systemd:
        name: tomcat
        state: started